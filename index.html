<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>우리집가계부</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script>
</head>
<body>
<!--
[Web발신]
KB국민카드(7*1*)
홍*영님
09/14 01:53
18,160원
SK플래닛-페이코 스타샵 사용
<11번가 코디휴지>

[Web발신]
KB국민카드7*1* 승인
홍*영
5,650원 일시불 09/21 17:59
사과나무슈퍼
커피우유 꽁기꽁기

2017.09.21 목요일 20:14 349402-**-***677 59,917
SK브로드밴드 출금
불광

-->
<div class="container-fluid">
    <div class="row">
        <textarea id="sms" style="width:100%;height:200px;"></textarea>
        <div style="width:100%;padding-top:10px;"><button type="button" class="btn btn-info btn-lg btn-block" onclick="cleanup();">등록하기</button></div>
    </div>
</div>
<script>
function toStr(n){return (n<10) ? "0"+n : ""+n};
function cleanup(){
    var sms = $("#sms").val().split(/\n/);
    $(sms).each(function(i,item){
        sms[i] = item.trim();
    });
    // 기본 데이터설정
    var data = {
        origin:sms.join("|"), // 등록된 원문(줄바꿈만 "|"로 변경)
        date:(function(d){return toStr(d.getFullYear())+toStr(d.getMonth()+1)+toStr(d.getDate())+toStr(d.getHours())+toStr(d.getMinutes())})(new Date()), // 현재날짜.
        price:0, // 카드금액
        cash:0, // 현금금액
        type:"", // 국민봉올림 | 국민마올림 | 현대M | 현대ZERO | 생활비현금 | 생활비이체
        store:"", // 사용처
        comment:"" // 추가 내용.
    };

    // 결제방법(type) 구하기
    if( (/7\*0\*/).test(data.origin) ){
        data.type = "국민봉올림";
    }else if( (/7\*1\*/).test(data.origin) ){
        data.type = "국민마올림";
    }else if( (/(현대카드 M)/).test(data.origin) ){
        data.type = "현대M";
    }else if( (/(현대카드 ZERO)/).test(data.origin) ){
        data.type = "현대ZERO";
    }else if( (/349402/).test(data.origin) ){
        data.type = "생활비이체";
    }else{
        data.type = "생활비현금";
    };

    if(data.type == "생활비이체"){
        var accountText = sms[0].split(" ");
        data.date = (accountText[0] +""+ accountText[2]).replace(/[^\d]+/g, ''); // 시간구하기
        data.cash = (accountText[4]).replace(/[^\d]+/g, '');
        data.store = accountText[5];
        data.comment = (sms[1]) ? sms[1] : "";
    }else if(data.type == "생활비현금") {
        // 현금일때
        data.cash = sms[0];
        data.comment = sms[1];
    }else{
        // 카드일때
        // 금액 구하기
        data.price = ((data.origin.match(/([0-9,]+)(원?)/))[1]).replace(/[^\d]+/g, '');

        // 사용처 구하기
        $(sms).each(function(i,item){
            if( (/([0-9,]+)(원)/).test(item) ){
                if(data.type == "국민마올림"){
                    data.store = sms[i+1];
                }else{
                    data.store = sms[i+2];
                }
            };
        });


        // 코멘트 구하기
        data.comment = sms[sms.length-1];
        data.comment = (/누적/).test(data.comment) ? "" : data.comment;

        // 시간구하기
        var date = ((data.origin.match(/([0-9]{2})(\/)([0-9]{2})/))[0]).split("/"); // 날짜
        var time = ((data.origin.match(/([0-9]{2})(\:)([0-9]{2})/))[0]).split(":");; // 시간
        var yyyy = new Date().getFullYear()+"";
        data.date = yyyy+""+date.join("")+""+time.join("");
    };

    var str = data.type+"\n"+data.price+"\n"+data.store+"\n"+data.comment+"\n맞나요?";
    if(confirm(str)){
        $.ajax({
            method: "POST",
            url: "https://script.google.com/macros/s/AKfycbw3KsXcgcrixfPJhBWbCCzWM5Re7qBJa54BNylgUT3_DSrupi0/exec",
            data: data
        }).done(function( msg ) {
            alert("저장되었습니다.");
            $("#sms").val("");
        });
    };
};
</script>
</body>
</html>